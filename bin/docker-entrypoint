#!/usr/bin/env bash
set -euo pipefail

# --- NEW: Check for an unexpected first argument and ignore it ---
# This often happens when Kamal/Docker wraps the entrypoint execution.
# This prevents the ArgumentError on db:prepare and runner commands.
if [ "$1" = "sh" ] || [ "$1" = "bundle" ]; then
    # Keep the argument if it's part of the actual command
    true
else
    # If the first argument is NOT the intended command, shift it off
    # to clean up the positional arguments for later Rails commands.
    if [ "$#" -gt 0 ]; then
        shift
    fi
fi
# -----------------------------------------------------------------

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails/tmp/pids/server.pid

# ... (Database check logic remains the same) ...

# Extract database connection details from DATABASE_URL
if [ -n "${DATABASE_URL:-}" ]; then
  temp="${DATABASE_URL#*://}"
  DB_USER="${temp%%:*}"
  temp="${temp#*:}"
  temp2="${temp##*@}"
  DB_HOST="${temp2%%:*}"

  echo "Waiting for PostgreSQL at ${DB_HOST} (user: ${DB_USER})..."

  retries=30
  count=0
  until pg_isready -h "${DB_HOST}" -U "${DB_USER}" -q; do
    count=$((count + 1))
    if [ $count -ge $retries ]; then
      echo "ERROR: PostgreSQL did not become available after $retries attempts"
      exit 1
    fi
    echo "PostgreSQL is unavailable - sleeping (attempt $count/$retries)"
    sleep 2
  done

  echo "PostgreSQL is up!"
else
  echo "WARNING: DATABASE_URL not set, skipping database check"
fi

# Prepare database (creates if needed, runs migrations)
echo "Preparing database..."
if ! bin/rails db:prepare 2>&1; then
  echo "ERROR: db:prepare failed!"
  exit 1
fi

echo "Database ready!"

# Test Rails environment loads correctly before starting Puma
echo "Testing Rails environment..."
if ! bin/rails runner "puts 'Rails OK: ' + Rails.env" 2>&1; then
  echo "ERROR: Rails environment failed to load!"
  echo "Dumping environment variables (redacted):"
  env | grep -E '^(RAILS_|DATABASE_|REDIS_|SECRET_)' | sed 's/=.*/=***REDACTED***/'
  exit 1
fi

echo "Starting application server..."

# Exec the main container process (Puma)
# REVERTED TO THE SIMPLER FORM SINCE SHIFTING CLEANSED ARGUMENTS
exec "$@"