#!/usr/bin/env bash
set -euo pipefail

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails/tmp/pids/server.pid

# Extract database connection details from DATABASE_URL
# Format: postgresql://user:pass@host:port/database
# This handles passwords with special characters correctly
if [ -n "${DATABASE_URL:-}" ]; then
  # Remove the protocol prefix
  temp="${DATABASE_URL#*://}"

  # Extract username (everything before first colon)
  DB_USER="${temp%%:*}"

  # Remove username and colon to get the rest
  temp="${temp#*:}"

  # Extract host (everything between @ and :)
  # Find the LAST @ (in case password contains @)
  temp2="${temp##*@}"
  DB_HOST="${temp2%%:*}"

  echo "Waiting for PostgreSQL at ${DB_HOST} (user: ${DB_USER})..."

  # Wait for PostgreSQL with retry logic
  retries=30
  count=0
  until pg_isready -h "${DB_HOST}" -U "${DB_USER}" -q; do
    count=$((count + 1))
    if [ $count -ge $retries ]; then
      echo "ERROR: PostgreSQL did not become available after $retries attempts"
      exit 1
    fi
    echo "PostgreSQL is unavailable - sleeping (attempt $count/$retries)"
    sleep 2
  done

  echo "PostgreSQL is up!"
else
  echo "WARNING: DATABASE_URL not set, skipping database check"
fi

# Prepare database (creates if needed, runs migrations)
echo "Preparing database..."
bundle exec rails db:prepare

echo "Database ready!"

# Exec the main container process (Puma)
exec "$@"
