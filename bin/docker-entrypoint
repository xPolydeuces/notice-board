#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails/tmp/pids/server.pid

# Extract database host from DATABASE_URL
# Format: postgresql://user:pass@host:port/database
DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:]*\):.*/\1/p')
DB_USER=$(echo $DATABASE_URL | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
 
# Wait for PostgreSQL
echo "Waiting for PostgreSQL at ${DB_HOST}..."
until pg_isready -h ${DB_HOST} -U ${DB_USER}; do
  echo "PostgreSQL is unavailable - sleeping"
  sleep 1
done
echo "PostgreSQL is up!"

# Check if database exists and create/migrate if needed
echo "Checking database..."
if bin/rails db:version 2>/dev/null; then
  echo "Database exists, checking for pending migrations..."
  bin/rails db:migrate
else
  echo "Database not found, creating..."
  bin/rails db:create
  bin/rails db:migrate
  bin/rails db:seed
fi

echo "Database ready!"

# Then exec the container's main process (what's set as CMD in the Dockerfile)
exec "$@"
